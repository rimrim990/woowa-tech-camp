# 친절한 SQL 튜닝 (개발자를 위한 SQL 튜닝 입문서)

## 4장. 조인 튜닝

### NL 조인

**NL 조인 매커니즘**
- `NL 조인`은 `Nested Loop` (중첩문) 구조를 사용하여 조인 연산을 수행한다.
```
begin
	for outer in (select ..)
	loop		--- outer 루프
		for inner in (select )
		loop	--- inner 루프
			dbms_output.put_line()
		end loop;
	end loop;
end;
```
- NL 조인은 Outer 와 Inner 테이블 모두 인덱스를 이용한다.
  - Outer 는 테이블 사이즈가 크기 않다면, Table Full Scan 이용 할 수도 있음 (한 번만 하면 되므로)
  - Inner 는 Outer 루프에서 읽은 데이터 건수만큼 Table Full Scan 을 수행하게 되므로, 인덱스를 사용해야 함 
- NL 조인은 하나의 레코드에 대해 순차적으로 작업을 마친 후, 다음 레코드로 넘어간다.
  - Outer 인덱스 레인지 스캔
  - 레코드 필터링을 위해 Outer 테이블 접근
  - Outer 레코드가 필터링 되지 않았다면, 조인 조건을 만족하는 Inner 인덱스 레인지 스캔
  - 레코드 필터링을 위해 Inner 테이블 접근

**NL 조인 튜닝 포인트**
- Outer 테이블에서 인덱스 레인지 스캔 시, 많은 테이블 랜덤 I/O 가 발생했지만 대부분 필터링 되었다면?
  - 인덱스에 필터링 컬럼 정보 추가
- 조인 횟수가 많지만 대부분 필터링 되었다면 ?
  - 인덱스에 필터링 컬럼 정보 추가
- OLTP 시스템에서 튜닝할 때는 일차적으로 NL 조인부터 고려하는 것이 올바른 순서

**NL 조인 특징 요약**
- 랜덤 액세스 위주의 조인 방식이다
  - 레코드 하나를 읽으려고 블록을 통째로 읽는 랜덤 액세스 방식은 메모리 버퍼에서 빠르게 읽더라도 비효울 존재
  - 인덱스 구성이 아무리 완벽해도 대량 데이터 조인 시에 NL 조인이 불리한 이유
- 조인을 한 레코드씩 순차적으로 진행한다
  - 큰 테이블을 조인하더라도 부분 범위 처리가 가능하기 때문에 매우 빠른 응답 속도
- 다른 조인 방식과 비교할 때 인덱스 구성 전략이 특히 중요하다
- NL 조인은 소량 데이터를 주로 처리하거나 부분범위 처리가 가능한 OLTP 시스템에 적합한 조인 방식이다