# 친절한 SQL 튜닝 (개발자를 위한 SQL 튜닝 입문서)

## 4장. 조인 튜닝

### 해시 조인

**기본 매커니즘**
- 작은 쪽 테이블을 읽어 해시 테이블을 생성한다.	
  - 옵티마이저는 일반적으로 카디널리티가 작은 테이블을 작은 테이블로 선정 (해시 충돌 때문인 듯 ?)
  - 조인 컬럼을 해시 테이블의 키 값으로 사용
  - 해시 테이블은 `PGA` 영역에 할당된 `Hash Area` 에 저장되는데, 해시 테이블이 너무 크면 `Temp` 테이블 스페이스에 저장
- 큰 쪽 테이블을 읽어 해시 테이블을 탐색하면서 조인한다.
  - 조인 컬럼을 해시 함수에 입력하여 반환된 값으로 해시 체인을 찾고, 해시 체인을 스캔하여 값이 같은 사원번호를 찾음
  - 찾으면 조인에 성공한 것이고, 못 찾으면 실패한 것

**해시 조인이 빠른 이유**
- 해시 테이블이 `PGA` 영역에 할당되기 때문에 래치 획득 과정 없이 빠르게 데이터를 탐색하고 조인한다.
- 소트 머지 조인은 양쪽 데이터 집합을 모두 정렬해서 `PGA` 에 담는데, `PGA` 는 큰 메모리 공간이 아니기 때문에 디스크 쓰기 작업 (`Temp` 테이블 스페이스) 을 반드시 수반한다.
- 반면에 해시 조인은 양쪽 집합 중 작은 쪽을 읽어 해시 테이블을 생성하므로 디스크에 쓰는 작업이 일어나지 않는다.

**조인 메서드 선택 기준**
- 소량 데이터 조인할 때 -> `NL 조인`
- 대량 데이터 조인할 때 -> `해시 조인`
- 대량 데이터 조인인데 해시 조인으로 처리할 수 없을 때 -> `소트 머지 조인`
- 수행 빈도가 높은 쿼리라면 웬만하면 `NL 조인` 사용하기
  - `NL 조인` 에 사용되는 인덱스는 영구적으로 유지하면서 다양한 쿼리를 위해 공유 및 재사용되는 자료구조
  - 반면 해시 테이블은 단 하나의 쿼리를 위해 생성하고 조인이 끝나면 곧바로 소멸하는 자료구조
  - 수행시간이 짧으면서 수행빈도가 매우 높은 쿼리 (OLTP 성 쿼리) 를 해시 조인으로 처리하면 `CPU` 와 메로리 사용률이 크게 증가
  - OLTP 환경에서 최적화된 (비효율이 없는) `NL 조인` 으로 0.1 초 걸리는 쿼리를 0.01 초로 단축할 목적으로 해시 조인을 쓰는 것은 가급적 자제하라 !