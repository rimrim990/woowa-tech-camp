# 친절한 SQL 튜닝 (개발자를 위한 SQL 튜닝 입문서)

## 4장. 조인 튜닝

### 소트 머지 조인

**오라클 SGA vs PGA**
- 공유 메모리 영역인 `SGA` 에 캐시된 데이터는 여러 프로세스가 공유할 수 있다.
  - 동시 접근은 불가능하므로, 여러 프로세스 간 동시 접근을 직렬화하기 위한 `Lock` 매커니즘으로서 래치 사용
- `SGA` 의 대표적인 구성 요소로는 데이터 블록과 인덱스 블록을 캐싱하는 `DB 버퍼캐시` 가 있다.
- 프로세스의 독자적인 메모리 공간인 `PGA` 는 각 오라클 서버 프로세스에 할당된다.
  - `PGA` 공간이 작아 데이터를 모두 저장할 수 없을 때는 `Temp` 테이블 스페이스 (디스크 영역) 을 사용
- `PGA 는 래치 매커니즘이 불필요하기 때문에 같은 양의 데이터를 읽더라도 `SGA` 버퍼캐시에서 읽을 때보다 훨씬 빠르다

**소트 머지 조인의 기본 매커니즘**
- 소트 단계 - 양쪽 집합을 조인 컬럼 기준으로 정렬한다
  - Outer 테이블을 정렬하여 `PGA` 에 할당된 `Sort Area` 에 저장
  - Inner 테이블을 정렬하여 `PGA` 에 할당된 `Sort Area` 에 저장
  - `PGA` 에 담을 수 없으면 `Temp` 테이블 스페이스에 저장
- 머지 단계 - 정렬한 양쪽 집합을 서로 머지한다
  - `PGA` (또는 `Temp`) 에 저장한 Outer 테이블 데이터를 스캔하면서 Inner 테이블과 조인한다
  - 머지 단계는 `NL 조인` 과 다르지 않음
  - Inner 테이블 데이터를 매번 Full Scan 하지 않아도 됨

**소트 머지 조인이 빠른 이유**
- `NL조인` 과 다르게 프로세스 전용 메모리 공간인 `PGA` 를 사용하기 때문에 래치 획득 과정이 필요없다.
  - 이것이 대량 데이터 조인에 유리한 이유

**소트 머지 조인의 주용도**
- 대부분의 상황에서 소트 머지 조인보다 해시 조인이 빠르다
- 그러나 해시 조인은 동등 조건에만 사용가능하므로, 동등 조건이 아닌 대용량 데이터 조건에 소트 머지 조인 사용이 가능하다
- 조인 조건식이 아예 없는 조인인 카테시안 곱에도 사용 가능하다